<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="/layout/header :: headerFragment"/>
<body>
  <div class="password_confirm">
    <h5 class="password_title">
      <strong>비밀번호 확인</strong>
    </h5>
    <th:block th:if="${reqType} == '1'">
      <h6 class="password_desc">
        사유
        <span class="description">게시글 삭제</span>
      </h6>
      <section>
        <div class="alert alert-warning">
          <p>
            작성자만 글 삭제할 수 있습니다.<br/>
            작성자 본인이라면, 글 작성시 입력한 비밀번호를 입력하여 글을 삭제할 수있습니다.
          </p>
        </div>
      </section>
    </th:block>
    <section>
       <label class="password_field_title">비밀번호</label>
       <label class="password_field">
         <input type="password" name="password" class="required" title="비밀번호"/>
       </label>
    </section>
    <div class="bt_wrap">
      <a href="#" class="warning" id="delBtn">확인</a>
      <a href="#" class="" id="cancelBtn">취소</a>
    </div>
  </div>
  <form id="reqForm" method="get">
    <input type="hidden" name="page" th:value="${postSearch.page}">
    <input type="hidden" name="size" th:value="${postSearch.size}">
    <input type="hidden" name="kw_opt" th:value="${postSearch.kw_opt}">
    <input type="hidden" name="kw" th:value="${postSearch.kw}">
  </form>
</body>
<th:block th:replace="/layout/footer :: footerFragment"/>
<script th:inline="javascript">
  $(document).ready(function(){
      let rf = $("#reqForm");
      let postId = [[${postId}]];
      let passwordInput = $("input[name=password]");

      passwordInput.on("keyup paste", function(){
        common.validate.password($(this));
      });

      $(".bt_wrap #delBtn").click(function(e){
        if(common.validate.checkRequired(".password_field input.required")
          && confirm("삭제하시겠습니까? 삭제한 후에는 되돌릴 수 없습니다.")){
          let jsonData = {'password' : passwordInput.val()};
          $.ajax({
            url : '/posts/'+postId,
            contentType: 'application/json',
            method: 'DELETE',
            data: JSON.stringify(jsonData),
            success: function(response) {
              console.log(response);
              rf.attr("action","/posts");
              rf.submit();
            },
            error: function(response) {
              console.log(response);
              let responseJson = response.responseJSON;
              let rCode = responseJson.code;
              let rMessage = responseJson.message;

              if(rMessage != null){
                alert(rMessage+"(오류코드 : "+rCode+")");
              }else{
                alert("저장에 실패하였습니다. (오류코드 : "+rCode+")");
              }
            }
          });
        }
      });

      $(".bt_wrap #cancelBtn").click(function(e){
          rf.attr("action", "/posts/"+postId);
          rf.submit();
      });
  });
</script>
</html>